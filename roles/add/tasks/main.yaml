---
- name: add this instance to cluster
  delegate_to: 'localhost'
  delegate_facts: true
  set_fact:
    cluster: "{{ hostvars['localhost'].cluster }},{{ inventory_hostname }}=https://{{ etcd_ip }}:2380"
- name: debug cluster
  debug:
    msg: '{{ hostvars["localhost"].cluster }}'
- name: run add command
  delegate_to: '{{ hostvars["localhost"]["etcd_main"] }}'
  command: '/opt/etcd/bin/etcdctl --cacert /etc/etcd/pki/ca.crt --key /etc/etcd/pki/etcd.key --cert /etc/etcd/pki/etcd.crt --endpoints https://{{ hostvars[ hostvars["localhost"]["etcd_main"] ].etcd_ip }}:2379 member add {{inventory_hostname}} --peer-urls=https://{{etcd_ip}}:2380 --learner'
- name: get id
  delegate_to: '{{ hostvars["localhost"]["etcd_main"] }}'
  command: '/opt/etcd/bin/etcdctl --cacert /etc/etcd/pki/ca.crt --key /etc/etcd/pki/etcd.key --cert /etc/etcd/pki/etcd.crt --endpoints https://{{ hostvars[ hostvars["localhost"]["etcd_main"] ].etcd_ip }}:2379 member list -w json'
  register: get_id_output
- debug:
    var: get_id_output
- set_fact:
    new_member_query: 'members[?(isLearner==`true`)].ID'  
- debug:
    var: new_member_query
- set_fact:
    new_member_content: '{{ get_id_output.stdout }}'
- set_fact:
    new_member_id: "{{ '%0x' % (new_member_content | json_query(new_member_query) | first | int ) }}"
- debug:
    var: new_member_id
- name: install
  include_role:
    name: install
- name: wait for the instance to be promoted
  import_tasks: wait.yaml
  until: promote_result.rc == 0
  retries: 10
  delay: 60
- debug:
    var: new_members_ok
